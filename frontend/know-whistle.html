<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Know the Whistle</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    /* Basic inline styles - move to style.css for larger projects */
    body { font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; padding: 1rem 2rem; line-height: 1.6; }
    h1 { text-align: center; color: #333; }
    .filter-bar {
      background-color: #eee;
      padding: 1rem;
      margin-bottom: 1.5rem;
      border-radius: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: center;
    }
    .filter-bar label { font-weight: bold; margin-right: 0.5rem;}
    .report-card {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 1rem 1.5rem;
      margin-bottom: 1rem;
      background-color: #ffffff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      overflow-wrap: break-word;
    }
    .report-card h3 { margin-top: 0; margin-bottom: 0.5rem; color: #0056b3; }
    .report-meta { font-size: 0.9rem; color: #555; margin-bottom: 0.5rem; }
    .report-body { margin-top: 0.5rem; margin-bottom: 0.5rem; }
    .report-score { font-size: 0.85rem; color: #666; font-style: italic; }
    .report-file a {
        display: inline-block;
        margin-top: 0.5rem;
        padding: 0.3rem 0.7rem;
        background-color: #007bff;
        color: white;
        text-decoration: none;
        border-radius: 4px;
        font-size: 0.9rem;
    }
    .report-file a:hover { background-color: #0056b3; }
    select, input[type="date"], button {
      padding: 0.5rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 1rem;
    }
    button { background-color: #28a745; color: white; cursor: pointer; border: none; }
    button:hover { background-color: #218838; }
    #reportList p { text-align: center; font-style: italic; color: #777;}
  </style>
</head>
<body>
  <h1>Know the Whistle</h1>

  <div class="filter-bar">
    <div>
      <label for="categoryFilter">Category:</label>
      <select id="categoryFilter">
        <option value="">All</option>
      </select>
    </div>
    <div>
      <label for="fromDate">From:</label>
      <input type="date" id="fromDate">
    </div>
    <div>
      <label for="toDate">To:</label>
      <input type="date" id="toDate">
    </div>
    <div>
       <button onclick="applyFilters()">Filter Reports</button>
    </div>
  </div>

  <div id="reportList">
    <p>Loading reports...</p>
  </div>

  <script>
    let allReports = [];
    const API_BASE_URL = "http://127.0.0.1:8000";

    async function fetchReports() {
      console.log("Fetching reports from API...");
      const reportListContainer = document.getElementById("reportList");
      try {
        const response = await fetch(`${API_BASE_URL}/reports`);
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(`API Error: ${response.status} - ${errorData.detail || response.statusText}`);
        }
        const data = await response.json();
        console.log(`Received ${data.length} reports.`);
        allReports = data;
        populateFilters(allReports);
        displayReports(allReports);
      } catch (error) {
        console.error("Failed to fetch reports:", error);
        reportListContainer.innerHTML = `<p style="color: red;">Error loading reports: ${error.message}. Please try refreshing.</p>`;
      }
    }

    function populateFilters(reports) {
      const categorySelect = document.getElementById("categoryFilter");
      categorySelect.innerHTML = '<option value="">All</option>';
      const categorySet = new Set(reports.map(r => r.category).filter(Boolean));
      categorySet.forEach(cat => {
        const option = document.createElement("option");
        option.value = cat;
        option.textContent = cat.charAt(0).toUpperCase() + cat.slice(1);
        categorySelect.appendChild(option);
      });
      console.log("Populated category filters.");
    }

    function displayReports(reports) {
      const container = document.getElementById("reportList");
      container.innerHTML = "";

      if (!reports || reports.length === 0) {
        container.innerHTML = "<p>No reports found matching your criteria.</p>";
        return;
      }

      console.log(`Displaying ${reports.length} reports.`);
      for (const report of reports) {
        const card = document.createElement("div");
        card.className = "report-card";

        // --- MODIFIED LINE: Points to /download endpoint ---
        const fileLinkHtml = report.file
          ? `<div class="report-file"><a href="${API_BASE_URL}/download/${encodeURIComponent(report.file)}" target="_blank">üìé Download Attached File</a></div>`
          // Note: We removed the 'download' attribute here as FileResponse handles forcing the download
          : "";

        card.innerHTML = `
          <h3>${escapeHtml(report.heading || 'No Heading')}</h3>
          <div class="report-meta">
            üìÖ ${escapeHtml(report.date || 'N/A')} |
            üìç ${escapeHtml(report.location || 'N/A')} |
            üè∑Ô∏è ${escapeHtml(report.category || 'N/A')}
          </div>
          <p class="report-body">${escapeHtml(report.body || 'No details provided.')}</p>
          <div class="report-score">Credibility Score: ${escapeHtml(report.score !== undefined ? report.score : 'N/A')}</div>
          ${fileLinkHtml}
        `;
        container.appendChild(card);
      }
    }

    function applyFilters() {
      const categoryFilter = document.getElementById("categoryFilter").value;
      const fromDateFilter = document.getElementById("fromDate").value;
      const toDateFilter = document.getElementById("toDate").value;

      console.log(`Applying filters: Category='${categoryFilter}', From='${fromDateFilter}', To='${toDateFilter}'`);
      const filteredReports = allReports.filter(report => {
        const matchCategory = !categoryFilter || report.category === categoryFilter;
        let matchDate = true;
        if (fromDateFilter || toDateFilter) {
            try {
                const reportDateOnly = report.date.split(' ')[0];
                const reportDateObj = new Date(reportDateOnly);
                if (isNaN(reportDateObj.getTime())) return false;
                const fromDateObj = fromDateFilter ? new Date(fromDateFilter) : null;
                const toDateObj = toDateFilter ? new Date(toDateFilter) : null;
                const matchFrom = !fromDateObj || isNaN(fromDateObj.getTime()) || reportDateObj >= fromDateObj;
                const matchTo = !toDateObj || isNaN(toDateObj.getTime()) || reportDateObj <= toDateObj;
                matchDate = matchFrom && matchTo;
            } catch (e) {
                console.warn("Error parsing date during filtering:", e);
                matchDate = false;
            }
        }
        return matchCategory && matchDate;
      });
      console.log(`Found ${filteredReports.length} reports after filtering.`);
      displayReports(filteredReports);
    }

    function escapeHtml(str) {
    if (str === null || str === undefined) return '';
    return String(str).replace(/[&<>"']/g, function (match) {
        return {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#39;'
        }[match];
    });
}

    document.addEventListener('DOMContentLoaded', fetchReports);
  </script>
</body>
</html>